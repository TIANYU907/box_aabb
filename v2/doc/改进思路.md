# v2 算法改进计划（详细执行版）

## 0. 文档目的

基于以下四条改进方向，形成可落地的研发计划：

1. interval AABB 支持“连杆均分 n 段”计算；
2. 基于 DH 参数自适应识别“对 AABB 有效的关节”，并跳过零长度连杆；
3. KD/层级树划分时跳过对 AABB 无影响的维度（如 Panda 第 7 轴场景）；
4. 支持多线程 BoxForest 扩展。

本计划强调：**实现步骤、接口变更、验证标准、风险与回滚策略**。

---

## 1. 总体目标与成功指标

## 1.1 总体目标

- 在不破坏当前正确性（保守碰撞语义、现有 API、测试集）的前提下，提升 v2 在高维/复杂场景下的吞吐与可扩展性。

## 1.2 成功指标（KPI）

- 功能正确性：`v2/tests` 全绿；新增测试覆盖四项改进核心路径。
- 性能收益（目标区间，最终以基准实测为准）：
	- AABB 计算：在相同安全语义下，平均耗时下降 10%~35%；
	- Forest 扩展：单位时间新增 box 数提升 20%+；
	- 规划整体：典型场景总耗时下降 15%+ 或成功率提升。
- 稳定性：多线程模式下结果满足“可行性一致”（路径合法），统计波动可接受。

---

## 2. 现状评估（与四项需求对应）

1) **interval AABB 分段能力**
- 数值采样路径已有 `n_subdivisions`，interval 路径存在基础支持但在部分调用链（如碰撞检测）仍固定为单段语义。
- 需要把“分段粒度”提升为可配置，并贯通到 collision / forest / planner 关键路径。

2) **有效关节识别与零长度跳过**
- 目前在部分策略已存在 relevant joints 与 zero-length 处理。
- 仍需统一到 interval FK、层级缓存树、碰撞批处理路径，避免“局部实现、全局未生效”。

3) **无效维度跳过（树划分）**
- 当前层级树默认按 `depth % n_dims` 轮转切分，未利用“维度影响度”信息。
- 需构建 `active_split_dims`，保证切分集中在真正影响 AABB 的子空间。

4) **多线程 Forest 扩展**
- 当前主扩展路径为单线程迭代。
- 需拆分“候选生成/碰撞评估/树查询/提交合并”四阶段，设计线程安全提交协议。

---

## 3. 技术路线总览

采用“先保守、后并发”的分阶段路线：

- **P0 基线与可观测性**：补齐 profile 与指标采集；
- **P1 分段 interval AABB 贯通**；
- **P2 有效关节/维度裁剪**；
- **P3 多线程扩展（可开关）**；
- **P4 集成验证与回归基准**。

每阶段均提供：功能开关、回滚路径、独立验收。

---

## 4. 分项详细计划

## 4.1 改进项 A：interval AABB 全链路分段（n_sub）

### A.1 目标

- 将 `n_sub` 从“局部参数”升级为“全链路一致配置”，支持 collision/forest/planner 按需启用。

### A.2 设计要点

- 在 `PlannerConfig`（或 forest 侧 config）新增：
	- `interval_n_sub: int = 1`
	- `interval_skip_zero_length: bool = True`
- `CollisionChecker.check_box_collision` 调用 interval FK 时不再硬编码 `n_sub=1`，改为读取配置。
- 对分段结果定义统一聚合语义：
	- 检测场景：逐段短路 OR（任一段碰撞即碰撞）；
	- 统计场景：保留分段明细以支持诊断。

### A.3 实施步骤

1. 配置字段与默认值落地；
2. 调整 `check_box_collision`、相关调用链透传 `n_sub`；
3. 增加分段路径测试（`n_sub=1/2/4`）；
4. 基准比较不同 `n_sub` 对误报率/速度影响。

### A.4 验收标准

- `n_sub=1` 与当前行为一致（回归一致）；
- `n_sub>1` 功能稳定，无接口破坏；
- 文档补充“精度-性能权衡建议”。

---

## 4.2 改进项 B：DH 自适应有效关节与零长度统一跳过

### B.1 目标

- 用统一规则在全系统识别“对目标连杆 AABB 有贡献的维度”，减少无效计算。

### B.2 设计要点

- 在 `Robot` 层提供标准化接口：
	- `get_effective_joints_for_link(link_idx)`
	- `get_effective_dims_for_planning()`（可选）
- 合并目前 scattered 逻辑（strategy 中 `relevant_joints`、collision 中 zero-length 跳过）。
- interval FK 在构造区间时对“确定无影响维度”可直接使用常值中点/固定值，避免传播宽区间。

### B.3 实施步骤

1. 定义有效关节判定规则（基于 DH 链依赖 + 特殊结构）；
2. 在 `aabb/forest/planner` 三层替换为统一接口；
3. 增加模型级测试：2DOF、Panda、含零长度链条模型。

### B.4 验收标准

- 三层结果一致使用同一“有效关节集合”；
- 零长度连杆在全部路径（单点/批量/区间）表现一致；
- 性能有可观收益且不引入可行性错误。

---

## 4.3 改进项 C：层级树划分跳过无效维度

### C.1 目标

- 将 `split_dim = depth % n_dims` 升级为 `split_dim = active_dims[depth % len(active_dims)]`。

### C.2 设计要点

- 在树初始化时构建 `active_split_dims`：
	- 输入：机器人结构、关节限制、（可选）历史敏感度统计；
	- 输出：按影响度排序的维度列表。
- 若 `active_split_dims` 为空则回退全维轮转，保证鲁棒。
- 持久化格式中记录 active dims 元信息，防止加载行为不一致。

### C.3 实施步骤

1. 设计 `active_split_dims` 推断函数（静态规则优先，动态统计可后续加入）；
2. 修改 `HierAABBTree._split` 与路径推导逻辑；
3. 更新 `save/load` header 元数据兼容；
4. 对 Panda 场景验证“无效维度跳过”收益。

### C.4 验收标准

- 功能不退化：可行 box 搜索结果保持保守性；
- 在存在弱影响维度场景下，树深利用率与 FK 调用数有下降；
- 与旧缓存兼容（必要时提供迁移或降级读取）。

---

## 4.4 改进项 D：基于 KD-tree 子空间切分的多进程 BoxForest 并行扩展

### D.1 目标

- 在保持最终数据结构一致性的前提下，提高扩展阶段并行吞吐。

### D.2 并发模型（明确方案）

- **阶段 0：子空间预切分（KD-tree）**
	- 先在关节空间根区间上执行固定深度 KD-tree 切分；
	- 得到 $K$ 个两两不重叠子空间 $\{\mathcal{Q}_1,\dots,\mathcal{Q}_K\}$；
	- 切分维度优先使用 C 阶段得到的 `active_split_dims`。
- **阶段 1：1 子空间 = 1 进程并行扩展**
	- 每个进程只在自己的子空间内采样与扩展；
	- 局部执行 `find_free_box` 与局部 BoxForest 增长；
	- 禁止跨子空间写入，避免共享写冲突。
- **阶段 2：子空间结果汇总合并**
	- 主进程收集各子空间局部 forest；
	- 执行跨子空间边界邻接补边（仅相邻子空间边界带）；
	- 合并为全局 forest，并进行一次一致性校验。

> 关键原则：先“空间解耦”再并行，避免在同一子空间并发写导致的锁竞争与不确定性。

### D.2.1 跨子空间连接策略

- 仅对“共享切分面相邻”的子空间对进行连接检测；
- 在边界带内抽取候选 box 对（中心距离 + 共享面近似筛选）；
- 通过线段碰撞检测确认后补边，避免全量 $O(N^2)$ 跨区连接。

### D.2.2 伪代码流程图（用于直接实现）

```text
prepare-partition(root_intervals, depth, active_dims):
	partitions = kd_split(root_intervals, depth, active_dims)
	# partitions: disjoint subspaces [Q1..QK]
	assign worker_i <-> Qi (1 process per subspace)
	return partitions

worker-expand(worker_id, subspace_Qi, planner_cfg):
	init local_forest_i
	init local_hier_tree_i constrained in subspace_Qi
	while not reach_budget:
		seed = sample_in_subspace(subspace_Qi)
		box = find_free_box(seed, obstacles, constrained=subspace_Qi)
		if box is valid:
			local_forest_i.add_box_direct(box)
	save local_forest_i
	return local_forest_i

merge-connect(local_forests):
	global_forest = union_all(local_forests)
	dedup_boundary_boxes(global_forest, by_partition_priority)
	for each adjacent partition pair (Qi, Qj):
		candidates = find_boundary_band_candidates(Qi, Qj)
		add_cross_edges_if_collision_free(candidates)
	validate_invariants(global_forest)
	return global_forest
```

### D.2.3 函数级开发任务清单（可直接开工）

> 说明：按“先主路径、后清理”的顺序执行。每条任务包含：文件名 + 函数名 + 变更点。

#### A. 子空间预切分（prepare-partition）

1. **文件名**：`v2/src/planner/models.py`  
   **函数名**：`PlannerConfig`（dataclass 字段）  
   **变更点**：新增并行切分参数：
   - `parallel_partition_depth: int = 2`
   - `parallel_partition_dims: Optional[List[int]] = None`
   - `parallel_cross_partition_connect: bool = True`

2. **文件名**：`v2/src/forest/hier_aabb_tree.py`  
   **函数名**：`HierAABBTree.__init__`  
   **变更点**：新增 `active_split_dims` 初始化逻辑（从配置/默认推导），并保存到实例字段。

3. **文件名**：`v2/src/forest/hier_aabb_tree.py`  
   **函数名**：`_split`  
   **变更点**：将 `split_dim = depth % n_dims` 改为基于 `active_split_dims` 轮转；当 `active_split_dims` 为空时回退全维轮转。

4. **文件名**：`v2/src/forest/hier_aabb_tree.py`  
   **函数名**：新增 `build_kd_partitions(root_intervals, depth, dims)`  
   **变更点**：返回互不重叠子空间列表 `List[List[Tuple[float,float]]]`，并附带 `partition_id`。

5. **文件名**：`v2/src/planner/box_planner.py`  
   **函数名**：新增 `_prepare_partitions()`  
   **变更点**：调用 `build_kd_partitions`，构建 worker->partition 映射，输出分区元数据（区间、邻接分区对、边界规则）。

#### B. 子空间并行扩展（worker-expand）

6. **文件名**：`v2/src/planner/box_planner.py`  
   **函数名**：新增 `_expand_partition_worker(partition_meta, seed_seq, cfg)`  
   **变更点**：
   - 仅在 `partition_meta.intervals` 内采样；
   - 调用 `find_free_box(..., constrained=subspace)`（或等价裁剪）；
   - 产出局部 forest 序列化结果（box 列表 + 局部邻接）。

7. **文件名**：`v2/src/planner/box_planner.py`  
   **函数名**：`_sample_seed`（或新增 `_sample_seed_in_partition`）  
   **变更点**：支持按子空间区间采样，不允许越界到其他分区。

8. **文件名**：`v2/src/forest/hier_aabb_tree.py`  
   **函数名**：`find_free_box`  
   **变更点**：新增可选子空间约束参数（如 `constrained_intervals`）；下行/上行结果不得越过该约束。

9. **文件名**：`v2/src/planner/box_planner.py`  
   **函数名**：`_plan_impl`  
   **变更点**：接入多进程分支：
   - 并行启动 worker；
   - 收集局部结果；
   - 交给合并流程；
   - 保留单进程 fallback（开发阶段）。

#### C. 汇总合并与跨区连接（merge-connect）

10. **文件名**：`v2/src/forest/box_forest.py`  
	**函数名**：新增 `merge_partition_forests(local_forests, dedup_rule)`  
	**变更点**：合并局部 boxes/adjacency，执行边界去重（按 partition_id 优先级）。

11. **文件名**：`v2/src/forest/box_forest.py`  
	**函数名**：新增 `dedup_boundary_boxes(...)`  
	**变更点**：对切分面附近重复 box 做一致去重，保留唯一 owner。

12. **文件名**：`v2/src/planner/connector.py`  
	**函数名**：新增 `connect_across_partitions(partition_pairs, boxes, band_width)`  
	**变更点**：
	- 仅处理共享切分面的相邻分区；
	- 边界带候选筛选后做碰撞验证；
	- 写入跨区 edges。

13. **文件名**：`v2/src/planner/box_planner.py`  
	**函数名**：新增 `_merge_connect_partitions(local_results)`  
	**变更点**：调用 forest merge + connector cross-partition connect，产出全局 `valid_boxes/valid_adjacency/edges`。

14. **文件名**：`v2/src/forest/box_forest.py`  
	**函数名**：新增 `validate_invariants()`  
	**变更点**：校验无重叠不变量、邻接对称性、孤儿边清理。

#### D. 架构收敛（删除旧模式与冗余代码）

15. **文件名**：`v2/src/planner/box_planner.py`  
	**函数名**：`_plan_impl`、旧扩展分支函数  
	**变更点**：删除非 KD-tree 扩展模式入口与条件分支，仅保留 KD-tree 子空间并行主路径。

16. **文件名**：`v2/src/forest/box_forest.py`  
	**函数名**：`add_boxes` / `add_boxes_incremental`  
	**变更点**：✅ 已删除。旧“全局切分 + 去重叠安全网”路径已移除，仅保留 `add_box_direct` 主路径。

17. **文件名**：`v2/src/forest/deoverlap.py`  
	**函数名**：`deoverlap`、`subtract_box`  
	**变更点**：✅ 已删除。主路径不再依赖旧重叠处理，模块仅保留邻接检测与共享面计算功能。

18. **文件名**：`v2/src/planner/connector.py`  
	**函数名**：legacy tree-to-tree 连接相关函数  
	**变更点**：移除不再使用的 legacy 连接分支，统一到分区边界连接策略。

19. **文件名**：`v2/tests/**`  
	**函数名**：相关旧模式测试用例  
	**变更点**：
	- 删除旧模式用例；
	- 新增 KD-tree 子空间并行、合并一致性测试。

#### E. 实施顺序（建议）

20. **文件名**：`v2/doc/改进思路.md`（本计划）  
	**函数名**：N/A  
	**变更点**：执行顺序固定为：
	- 第 1 批：任务 1~5（切分基础）
	- 第 2 批：任务 6~9（worker 并行）
	- 第 3 批：任务 10~14（合并与补边）
	- 第 4 批：任务 15~19（删除旧模式与测试收敛）

#### F. 每批完成后的验收动作

- 运行：`python -m pytest v2/tests -q`
- 记录：
  - box 增长率（boxes/s）
  - 规划成功率
  - 路径合法性（碰撞复检）
  - 合并后不变量检查通过率

### D.3 接口与配置

- 在 `PlannerConfig` 增加：
	- `parallel_expand: bool = False`
	- `parallel_workers: int = 0`（0 表示自动，通常与子空间数一致）
	- `parallel_batch_size: int = 32`
	- `parallel_partition_depth: int = 2`（KD-tree 预切分深度）
	- `parallel_partition_dims: Optional[List[int]] = None`（默认使用 active dims）
	- `parallel_cross_partition_connect: bool = True`
- 默认关闭，作为实验特性逐步放量。

### D.3.1 架构收敛（强制 KD-tree 单模式）

> 本项为你提出的“代码收敛要求”：box 扩展仅保留 KD-tree 切分模式。

- 目标：
	- 只保留“KD-tree 子空间切分 + 多进程扩展 + 合并补边”主路径；
	- 删除其他 box 扩展模式与分支逻辑，降低维护复杂度。

- 代码改造清单（计划项）：
	1. 删除非 KD-tree 的 box 扩展入口与配置分支；
	2. 删除旧 box 切分策略代码（与 KD-tree 主路径重复/冲突的部分）；
	3. ✅ 已删除旧重叠检测/去重叠路径（`deoverlap`/`subtract_box`）；
	4. 保留最小必要的边界去重与一致性校验逻辑；
	5. 清理测试与文档中已移除模式的引用。

- 约束：
	- 删除动作必须在“新主路径测试全绿 + 基准达标”后执行；
	- 删除前先打标签（或保留归档分支）以便审计。

### D.4 风险控制

- 非确定性：允许性能波动，但要求“成功率与可行性不下降”；
- 进程安全：子空间内本地写，跨子空间只在主进程合并；
- 负载均衡：若子空间障碍分布不均，支持动态子空间重分配（二期）；
- 边界效应：通过 KD 互斥切分 + 合并去重规则避免重复扩展；
- 调试能力：保留单线程模式作为对照与回滚。

### D.5 验收标准

- 并行模式下测试稳定通过；
- 相同配置下多次运行成功率无显著下降；
- 子空间并行与单线程在可行性上等价（路径合法、碰撞约束满足）；
- 合并后 forest 满足“无重叠不变量 + 邻接对称性”；
- 非 KD-tree 模式代码已清理，不再被构建/调用；
- 吞吐提升达到预期区间。

---

## 5. 里程碑与交付物

## M0（1~2 天）基线建立

- 交付：性能采样脚本、关键指标仪表（FK 次数/碰撞次数/box 增长率）。

## M1（2~4 天）A+B 落地

- 交付：分段 interval 配置贯通、有效关节统一接口、对应单元测试。

## M2（2~3 天）C 落地

- 交付：active dims 切分、缓存兼容方案、对照基准报告。

## M3（3~5 天）D 落地

- 交付：KD-tree 子空间并行扩展主路径、主进程合并逻辑、旧模式删除清单与稳定性报告。

## M4（1~2 天）收敛与文档

- 交付：最终 benchmark 报告、参数建议、失败回滚手册。

---

## 6. 当前进展状态（2026-02-22 更新）

### 6.1 已完成项

#### A/C/D 主线关键能力

1. KD 子空间切分与分区元数据准备已接入。
2. 分区 worker 扩展与 `constrained_intervals` 约束已接入。
3. ProcessPool 并行执行与进程内 fallback 已接入。
4. 分区结果合并、边界去重、跨区补边已接入。
5. 合并后不变量校验已收敛到 `strict=True`。

#### 重叠根因修复

已修复并行分支中"全空间起终点预扩展 + 分区扩展"叠加导致的重叠风险：

1. 并行模式取消全空间起终点预扩展；
2. 起终点扩展下放到分区 worker 子空间内执行；
3. 合并后执行强校验，异常直接暴露。

#### 重命名完成

- `BoxRRT` -> `BoxPlanner`，`box_rrt.py` -> `box_planner.py`
- `gcs_planner_panda.py` -> `panda_planner.py`
- 所有测试与文档同步更新

#### Coarsen 优化（C1-C5 全部完成）

1. **C1**: 合并期间使用 `add_box_no_adjacency` / `remove_boxes_no_adjacency`，最后一次 `rebuild_adjacency`
2. **C2**: 使用 NumPy 结构化数组 `np.unique` 替代 Python 循环分组（32ms vs 194ms）
3. **C3**: 新增 Cython `NodeStore.forest_ids_array()` 批量获取 forest ID 映射
4. **C4**: 移除 ThreadPoolExecutor（GIL 开销大于收益）
5. **C5**: 批量合并（k boxes -> 1 shot），两阶段检测+执行架构

**已修复的 bug**：
- IndexError：`_sweep_merge_dim` 使用全局索引访问局部数组 -> 改用 `sorted_lo[run_start]`
- Stale numpy view：`lo_dim`/`hi_dim` 是 `_intervals_arr` 的视图，被 swap-on-delete 修改 -> 加 `.copy()`
- 两阶段方案：分离只读检测与写入执行，防止跨组污染

**性能**：500 boxes -> 486 boxes, 12 merges, ~37ms（原 ~63ms）

#### Bridge 优化（B2, B3 完成；B1, B5 已回滚）

1. **B2**: `BoxNode.center` 在 `__post_init__` 缓存，避免重复创建数组
2. **B3**: 向量化桥接-box 邻接更新（使用 `_adjacent_existing_ids_from_cache`）
3. **B1 已回滚**: `compute_adjacency`（strict face-touching）仅 5 条边 vs loose overlap 的 157 条边，bridge/Dijkstra 需要后者
4. **B5 已回滚**: `clear_subtree_occupation` 清除所有后代节点，包括其他 box 的节点，导致桥接挂死

#### 端到端管线验证

Panda 7-DOF 典型场景（seed=1771593633）：
- grow=293ms（500 boxes）, coarsen=37ms（12 merges, 500->486）, adj=11ms, bridge=97ms, Dijkstra=61ms
- 总规划时间 ~500ms, 7 waypoints, cost=7.9951, SUCCESS
- 24/24 测试全通过

### 6.2 已验证结果

1. 并行烟测可运行并通过 strict 校验。
2. `v2/tests` 回归全通过（当前 24 passed）。
3. 端到端 Panda 规划成功运行并输出路径。

### 6.3 尚未彻底收敛项

1. "仅保留 KD 主模式、删除 legacy 分支"的代码清理尚未全部完成；
2. 并行专项自动化测试（固定 seed 的结构一致性回归）仍需补齐。

### 6.4 下一阶段建议顺序

1. 新增并行专项测试（重叠、合并一致性）；
2. 清理非 KD 扩展入口与无用旧路径；
3. 更新 benchmark 以加入 serial vs parallel 内部对照表；
4. 最终锁定参数建议与运维排障手册。
---

## 6. 测试与基准计划

## 6.1 测试层次

- 单元测试：
	- interval 分段一致性；
	- 有效关节选择正确性；
	- active dims 切分合法性。
- 集成测试：
	- planner 在典型场景可行；
	- 并行/串行模式结果可用性对照。
- 回归测试：
	- `v2/tests` 全量。

## 6.2 基准维度

- 时间：总耗时、各阶段耗时；
- 代价：碰撞检测次数、FK 次数；
- 质量：成功率、路径长度、box 数/边数。

---

## 7. 兼容性与回滚策略

- 所有新能力以配置开关引入，默认保持旧行为（`n_sub=1`, `parallel_expand=False`）。
- 任一阶段若出现质量回退，可按开关快速回滚到稳定路径（D 最终收敛后除外，依赖代码标签/归档分支回退）。
- 缓存格式变更需提供版本号与兼容读取（或显式迁移脚本）。
- D 项完成后，box 扩展将收敛为 KD-tree 单模式，不再提供旧模式开关。

---

## 8. 实施优先级建议

优先顺序：**A → B → C → D**。

原因：

- A/B 改造收益稳定、风险低，是后续优化的基础；
- C 依赖 B 的“有效维度”定义；
- D 并发收益高但工程风险最高，放在最后更稳。

---

## 9. 最终产出清单（完成态）

- 代码：A/B/C 可配置；D 收敛为 KD-tree 单模式（旧模式代码已删除）；
- 文档：参数说明、实验报告、故障排查指南；
- 质量：测试全绿 + 基准报告可复现；
- 结论：给出不同机器人/场景下的推荐参数模板。