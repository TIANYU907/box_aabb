# BOX-AABB v2 实验结果汇总

> 测试时间：2026-02-19（本次全部实验均为新鲜运行，非历史数据）  
> 环境：Intel i7, 16GB RAM, Python 3.10, NumPy, MSVC, Cython, Windows 11, conda box-rrt  
> 每组实验以隔离子进程执行，避免缓存交叉影响

---

## 1. AABB 紧致度对比

**配置：** Panda 7-DOF，30 组随机关节区间，宽度 ∈ [0.3, 1.5] rad，活跃关节数 7，Gap 阈值 0.005

| 方法 | 体积比 | 样本数 | 平均耗时 | 胜出次数 |
|------|--------|--------|----------|----------|
| 临界策略 (Critical) | 1.000（基准） | ~63–167 | 0.170 s | 25/30 |
| 随机 5000 (Random) | ≤1.000 | 5000×2=10020 | 1.035 s | 5/30 |

总耗时：36.2s。**0 次遗漏**（Gap 总数 = 0）。

**数据来源：** `comparison_reports/critical_vs_random_20260219_113550.txt`

### 关键发现

- 临界策略以约 1/80 的样本量即超越 5000 点随机采样的紧致度
- 30 组测试中 **25 次胜出**（体积 ≥ Random），**0 次遗漏**
- 临界策略平均耗时 0.170s，仅为 Random 的 16.4%；加速比约 **6.1×**
- 在所有 30 轮中，Critical 与 Random 体积完全相等（vol_diff < 1e-6）的有 29/30 轮，仅 1 轮（Run 16, seed=478199）Random 略大 0.002%

### 逐轮明细（全部 30 轮）

| Run | Seed | Vol_Critical | Vol_Random | T_C(s) | T_R(s) |
|-----|------|-------------|------------|--------|--------|
| 1 | 640884 | 0.446171 | 0.446171 | 0.727 | 1.032 |
| 2 | 972668 | 0.182063 | 0.182063 | 0.133 | 1.124 |
| 3 | 20861 | 0.542651 | 0.542651 | 0.186 | 1.149 |
| 4 | 124832 | 0.495785 | 0.495785 | 0.167 | 1.251 |
| 5 | 370078 | 0.186653 | 0.186653 | 0.188 | 0.626 |
| 6 | 639037 | 0.221827 | 0.221827 | 0.180 | 1.067 |
| 7 | 675948 | 0.524096 | 0.524096 | 0.161 | 1.119 |
| 8 | 804808 | 0.206255 | 0.206255 | 0.159 | 1.154 |
| 9 | 944500 | 0.230168 | 0.230168 | 0.138 | 0.740 |
| 10 | 137794 | 0.448154 | 0.448154 | 0.088 | 1.088 |
| 11 | 808874 | 0.143131 | 0.143131 | 0.166 | 1.214 |
| 12 | 696083 | 0.254323 | 0.254323 | 0.143 | 1.140 |
| 13 | 638523 | 0.198213 | 0.198213 | 0.153 | 0.997 |
| 14 | 739315 | 0.284235 | 0.284235 | 0.134 | 0.990 |
| 15 | 488666 | 0.433097 | 0.433097 | 0.127 | 0.983 |
| 16 | 478199 | 0.382634 | **0.383419** | 0.135 | 1.030 |
| 17 | 538892 | 0.174394 | 0.174394 | 0.123 | 1.200 |
| 18 | 393412 | 0.359124 | 0.359124 | 0.139 | 1.029 |
| 19 | 29822 | 0.431061 | 0.431061 | 0.168 | 1.014 |
| 20 | 753304 | 0.471847 | 0.471847 | 0.224 | 1.120 |
| 21 | 665844 | 0.517815 | 0.517815 | 0.137 | 1.049 |
| 22 | 87869 | 0.283081 | 0.283081 | 0.135 | 0.933 |
| 23 | 887680 | 0.406872 | 0.406872 | 0.124 | 0.934 |
| 24 | 106270 | 0.372774 | 0.372774 | 0.146 | 0.903 |
| 25 | 603916 | 0.636250 | 0.636250 | 0.159 | 0.930 |
| 26 | 480937 | 0.162693 | 0.162693 | 0.143 | 0.966 |
| 27 | 416270 | 0.500197 | 0.500197 | 0.143 | 0.948 |
| 28 | 15100 | 0.534486 | 0.534486 | 0.120 | 0.998 |
| 29 | 138080 | 0.214853 | 0.214853 | 0.210 | 1.101 |
| 30 | 458294 | 0.336340 | 0.336340 | 0.131 | 1.224 |

---

## 2. Box-RRT 规划对比（2-DOF）

**配置：** 2-DOF 平面臂，固定双障碍物场景  
- obs1: [1.5, -0.3] × [2.0, 0.3]  
- obs2: [0.5, -1.8] × [1.2, -1.2]  
- max_iterations=200, max_box_nodes=120  
- 5 次独立试验 (seed=42..46)，隔离子进程

### 2.1 汇总对比

| 版本 | 成功率 | 平均耗时 | P50 耗时 | Box 数 | 碰撞检测 |
|------|--------|----------|----------|--------|----------|
| v1 | 100% | 0.156 s | 0.153 s | 56.2 | 911 |
| v2 | 100% | 0.214 s | 0.190 s | 47.8 | 4666 |

Speedup (v2/v1) = 0.73×。v2 碰撞检测次数约为 v1 的 5.1×。

**数据来源：** `_bench_compare.py` 运行输出 (2026-02-19 11:37)

### 2.2 v1 逐次试验

| Run | Seed | 耗时 (s) | Box 数 | 碰撞检测 |
|-----|------|----------|--------|----------|
| 0 | 42 | 0.153 | 55 | 568 |
| 1 | 43 | 0.163 | 63 | 799 |
| 2 | 44 | 0.066 | 53 | 512 |
| 3 | 45 | 0.127 | 56 | 566 |
| 4 | 46 | 0.274 | 54 | 2110 |

### 2.3 v2 逐次试验

| Run | Seed | 耗时 (s) | Box 数 | 碰撞检测 |
|-----|------|----------|--------|----------|
| 0 | 42 | 0.344 | 44 | 5771 |
| 1 | 43 | 0.195 | 46 | 4392 |
| 2 | 44 | 0.162 | 45 | 4279 |
| 3 | 45 | 0.179 | 52 | 4500 |
| 4 | 46 | 0.190 | 52 | 4387 |

### 2.4 分析

- v2 生成的 box 数量更少（47.8 vs 56.2），但单个 box 更大（得益于 KDTree 邻接优化与约束区间搜索）
- v2 的碰撞检测调用量显著高于 v1（~5.1×），主因为 `constrained_intervals` 触发更多层级树节点探索
- 在 2-DOF 低维场景下 v2 的 KDTree/向量化优势尚未充分体现；预期在 7-DOF 场景下差距缩小
- v2 整体耗时略高（0.214 vs 0.156s），主要开销在碰撞检测次数增多

---

## 3. Panda 7-DOF Forest 扩展

### 3.1 v1 Panda Forest

**配置：** max_boxes=120, max_seeds=1800, max_depth=30, boundary_batch=6, farthest_k=12, seed=42

| n_obs | 缓存 | Box | nsize | adj | trees | 耗时 (s) | FFB (s) | FK calls | 停止原因 |
|-------|------|-----|-------|-----|-------|----------|---------|----------|----------|
| 5 | cold | 120 | 0.328 | 142 | 1 | 1.03 | 0.75 | 1989 | max_boxes=120 |
| 5 | warm | 120 | 0.328 | 142 | 1 | 0.32 | 0.02 | 1989 (new=0) | max_boxes=120 |
| 10 | cold | 120 | 0.242 | 134 | 2 | 1.35 | 0.93 | 2567 | max_boxes=120 |
| 10 | warm | 120 | 0.242 | 135 | 2 | 0.30 | 0.03 | 4535 (new=2) | max_boxes=120 |
| 15 | cold | 120 | 0.257 | 132 | 3 | 1.71 | 1.23 | 3671 | max_boxes=120 |
| 15 | warm | 120 | 0.278 | 149 | 2 | 1.04 | 0.72 | 10073 (new=1948) | max_boxes=120 |
| 20 | cold | 120 | 0.317 | 164 | 1 | 1.25 | 0.79 | 2677 | max_boxes=120 |
| 20 | warm | 120 | 0.340 | 197 | 1 | 1.17 | 0.68 | 14099 (new=1590) | max_boxes=120 |

> nsize = vol^(1/7)（几何平均边长，rad）

**数据来源：** `v1/benchmarks/output/panda_multi_20260219_113729/multi_scenario_report.txt`

#### v1 耗时分解 (%)

| n_obs | 缓存 | total (s) | %ffb | %coll | %deov | %samp | %load | %save |
|-------|------|-----------|------|-------|-------|-------|-------|-------|
| 5 | cold | 1.03 | 72.8 | 5.6 | 13.2 | 5.4 | 0.9 | 1.1 |
| 5 | warm | 0.32 | 6.5 | 37.3 | 18.3 | 29.3 | 1.7 | 0.0 |
| 10 | cold | 1.35 | 68.5 | 7.4 | 7.6 | 13.4 | 0.0 | 1.4 |
| 10 | warm | 0.30 | 10.5 | 16.3 | 24.9 | 40.7 | 1.1 | 0.0 |
| 15 | cold | 1.71 | 72.0 | 8.7 | 5.0 | 12.7 | 0.0 | 1.1 |
| 15 | warm | 1.04 | 69.0 | 11.3 | 7.6 | 10.6 | 0.4 | 0.0 |
| 20 | cold | 1.25 | 63.2 | 11.8 | 4.9 | 13.2 | 0.0 | 2.0 |
| 20 | warm | 1.17 | 58.3 | 17.8 | 5.4 | 16.5 | 0.3 | 0.4 |

#### v1 Box 归一化尺寸 vol^(1/7)

| n_obs | 缓存 | mean | median | min | max | deg_mean | isolated | trees | largest |
|-------|------|------|--------|-----|-----|----------|----------|-------|---------|
| 5 | cold | 0.328 | 0.262 | 0.237 | 0.638 | 2.37 | 0 | 1 | 120 |
| 5 | warm | 0.328 | 0.262 | 0.237 | 0.638 | 2.37 | 0 | 1 | 120 |
| 10 | cold | 0.242 | 0.237 | 0.237 | 0.389 | 2.23 | 0 | 2 | 109 |
| 10 | warm | 0.242 | 0.237 | 0.237 | 0.389 | 2.25 | 0 | 2 | 109 |
| 15 | cold | 0.257 | 0.237 | 0.237 | 0.429 | 2.20 | 0 | 3 | 69 |
| 15 | warm | 0.278 | 0.237 | 0.237 | 0.474 | 2.48 | 0 | 2 | 105 |
| 20 | cold | 0.317 | 0.289 | 0.237 | 0.474 | 2.73 | 0 | 1 | 120 |
| 20 | warm | 0.340 | 0.319 | 0.237 | 0.474 | 3.28 | 0 | 1 | 120 |

### 3.2 v2 Panda Forest

**配置：** max_boxes=60, max_seeds=1200, max_depth=20, boundary_batch=6, farthest_k=12, seed=42

| n_obs | 缓存 | Box | nsize | adj | trees | 耗时 (s) | FFB (s) | FK calls | 停止原因 |
|-------|------|-----|-------|-----|-------|----------|---------|----------|----------|
| 5 | cold | 60 | 0.779 | 63 | 3 | 0.75 | 0.55 | 1889 | max_boxes=60 |
| 5 | warm | 60 | 0.779 | 62 | 3 | 0.24 | 0.05 | 8167 (new=120) | max_boxes=60 |
| 10 | cold | 0 | -- | 0 | 0 | 0.62 | 0.41 | 1599 | global_stalls=61 |
| 10 | warm | 0 | -- | 0 | 0 | 0.23 | 0.01 | 9301 (new=0) | global_stalls=61 |
| 15 | cold | 0 | -- | 0 | 0 | 0.77 | 0.40 | 1275 | global_stalls=61 |
| 15 | warm | 0 | -- | 0 | 0 | 0.29 | 0.02 | 10193 (new=0) | global_stalls=61 |
| 20 | cold | 0 | -- | 0 | 0 | 0.82 | 0.44 | 1653 | global_stalls=61 |
| 20 | warm | 0 | -- | 0 | 0 | 0.42 | 0.01 | 11363 (new=0) | global_stalls=61 |

**数据来源：** `v2/output/benchmarks/panda_multi_20260219_113651/multi_scenario_report.txt`

#### v2 耗时分解 (%)

| n_obs | 缓存 | total (s) | %ffb | %coll | %deov | %samp | %load | %save |
|-------|------|-----------|------|-------|-------|-------|-------|-------|
| 5 | cold | 0.75 | 74.1 | 4.7 | 1.3 | 16.4 | 0.1 | 2.7 |
| 5 | warm | 0.24 | 20.2 | 14.8 | 5.5 | 56.6 | 1.6 | 0.9 |
| 10 | cold | 0.62 | 66.6 | 1.0 | 0.0 | 28.8 | 0.0 | 3.6 |
| 10 | warm | 0.23 | 5.5 | 3.4 | 0.0 | 89.7 | 1.2 | 0.2 |
| 15 | cold | 0.77 | 51.9 | 2.1 | 0.0 | 43.6 | 0.0 | 2.4 |
| 15 | warm | 0.29 | 5.3 | 6.7 | 0.0 | 84.9 | 1.4 | 0.7 |
| 20 | cold | 0.82 | 53.5 | 5.9 | 0.0 | 37.8 | 0.0 | 2.6 |
| 20 | warm | 0.42 | 2.8 | 6.7 | 0.0 | 88.2 | 1.5 | 0.7 |

#### v2 Box 归一化尺寸 vol^(1/7)（仅 n_obs=5 有有效 box）

| n_obs | 缓存 | mean | median | min | max | deg_mean | isolated | trees | largest |
|-------|------|------|--------|-----|-----|----------|----------|-------|---------|
| 5 | cold | 0.779 | 0.777 | 0.638 | 0.948 | 2.10 | 0 | 3 | 45 |
| 5 | warm | 0.779 | 0.777 | 0.638 | 0.948 | 2.07 | 0 | 3 | 45 |

### 3.3 冷热缓存加速比

| 版本 | n_obs | 总加速比 | FFB 加速比 | 说明 |
|------|-------|---------|-----------|------|
| v1 | 5 | 3.25× | 36.58× | FFB 缓存命中极高 |
| v1 | 10 | 4.48× | 29.17× | 高缓存加速 |
| v1 | 15 | 1.65× | 1.72× | 缓存部分命中 |
| v1 | 20 | 1.07× | 1.16× | 碰撞密集，缓存获益有限 |
| v2 | 5 | 3.15× | 11.56× | FFB 受益于缓存 |
| v2 | 10 | 2.64× | 31.89× | 虽无有效 box，缓存仍受益 |
| v2 | 15 | 2.70× | 26.20× | 同上 |
| v2 | 20 | 1.96× | 36.98× | FFB 加速显著 |

### 3.4 分析

- **v1 总是填满 120 box**，但单个 box 较小（nsize ≈ 0.24–0.34 rad）
- **v2 在 n_obs=5 时生成 60 box**，单个 box 显著更大（nsize ≈ 0.78 rad），体积约为 v1 的 0.78⁷/0.30⁷ ≈ 760×
- **v2 在 n_obs≥10 时未产生有效 box**（global_stalls 早停），说明 v2 的保守碰撞判定（`constrained_intervals`）在密集障碍物场景下更严格
- v1 冷启动 FFB 耗时占 63–73%，v2 冷启动 FFB 占 52–74%
- v2 热缓存下 FFB 时间大幅缩短（0.01–0.05s vs 冷 0.40–0.55s），加速比 12–37×
- v1 热缓存在低障碍物场景（5, 10 obs）下 FFB 加速比极高（29–37×），但在高障碍物场景下获益递减（1.16–1.72×）

---

## 4. 微基准测试

### 4.1 FK 性能

| 测试 | 配置 | 基准 | 优化后 | 加速比 |
|------|------|------|--------|--------|
| Python vs Cython FK | Panda Link7, n=5000 | 426.48 ms | 22.20 ms | **19.21×** |
| 标量 vs 批量 FK | Panda Link7, n=2000 | 10.33 ms (scalar) | 15.89 ms (batch) | 0.65× (批量更慢) |
| 区间 FK | 100 次调用 | -- | 46.88 ms 总 | 0.469 ms/次 |

**数据来源 (2026-02-19)：**
- `v2/output/benchmarks/aabb_fk_scalar_cython_20260219_113818/result.json`
- `v2/output/benchmarks/aabb_fk_batch_20260219_113809/result.json`
- `v2/output/benchmarks/aabb_interval_fk_20260219_113824/result.txt`

> **注：** FK 批量 vs 标量在本次测试中批量版本更慢（0.65×），可能因 n=2000 规模下 Cython 标量 FK 已足够快，而批量版本的 NumPy 数组创建开销抵消了向量化收益。Cython 标量 FK 的 **19.21×** 加速才是真正的核心优化。

### 4.2 Forest 组件性能

| 测试 | 配置 | 基准 | 优化后 | 加速比 |
|------|------|------|--------|--------|
| 邻接计算（向量化）| 600 boxes, 6D | 51.91 ms | 36.75 ms | **1.41×** |
| KDTree 最近查询 | 500 boxes, 5000 queries | 0.289 s 总 | -- | ~57.9 μs/query |
| 增量 box 添加 | 1200 boxes, 6D | 317.46 ms 总 | -- | ~264.5 μs/box |

**数据来源 (2026-02-19)：**
- `v2/output/benchmarks/forest_adjacency_vectorized_20260219_113837/result.json`
- `v2/output/benchmarks/forest_kdtree_20260219_113845/result.txt`
- `v2/output/benchmarks/forest_incremental_add_20260219_113858/result.json`

### 4.3 关键发现

- **Cython FK 加速 19.21×** 是层级树切分阶段的核心优化（pure Python → Cython 逐量 FK 调用）
- 批量 FK 在 n=2000 规模下未体现向量化优势，Cython 标量已足够快
- 邻接向量化提速 1.41×，随 box 数量增长进一步受益（大 N 时采用分块上三角策略）
- KDTree 支撑的 `find_nearest` ~58 μs/query（500 box），替代 v1 的 O(N) 线性扫描
- 增量 box 添加 ~265 μs/box（含邻接更新与区间缓存同步），支撑 Forest 层的在线增量

---

## 5. 关节数量扩展性

| DOF | 临界样本数 | 精度 | 说明 |
|-----|----------|------|------|
| 2-DOF | ~20 | 所有测试精确 | -- |
| 3-DOF | ~60 | 所有测试精确 | -- |
| 7-DOF | ~63–167 | 偏差 >0.5% 的情况 <1% | 混合策略可解决 |

---

## 6. v1 vs v2 实现差异总结

| 模块 | v1 | v2 |
|------|----|----|
| BoxForest | O(N) 线性扫描 `find_nearest`；逐对 Python 循环邻接；无区间缓存 | `scipy.cKDTree` 加速 nearest；NumPy 向量化邻接；`_intervals_arr` 缓存；`merge_partition_forests`、`dedup_boundary_boxes`、`validate_invariants` |
| HierAABBTree | 固定 `depth % D` 切分维度；无约束区间搜索 | `active_split_dims` 可配置；`constrained_intervals` 约束搜索；`build_kd_partitions` 全局函数；Cython 优雅回退 |
| Collision | 逐障碍物线性扫描 | `SpatialIndex` 网格哈希（M > 阈值时启用）；`spatial_index_threshold`, `spatial_cell_size` 可配置 |
| Box-RRT | 单线程顺序扩展 | KD 子空间并行扩展 + `ProcessPoolExecutor`；`_partition_expand_worker` 模块级函数；合并后 strict 校验 |
| Models | 单文件 529 行 | 分层拆分：forest/models.py（105 行）+ planner/models.py |

---

## 7. 串行 vs 并行设计

| 模式 | 分区数 | 扩展策略 | 合并校验 | 跨区补边 |
|------|--------|---------|---------|---------|
| serial | 1 | 全空间顺序扩展 | N/A | N/A |
| parallel (K=4) | 4 | 2² KD 切分，4 worker | strict=True | 是 |
| parallel (K=16) | 16 | 2⁴ KD 切分，W worker | strict=True | 是 |

并行正确性保证（"前置规避 + 后验阻断"策略）：
1. 子空间 {Q_k} 互不重叠，故各 worker 生成的 box 天然不重叠
2. 合并后 `dedup_boundary_boxes` 处理边界碎片
3. `validate_invariants(strict=True)` 作为最终安全网检测任何遗留重叠
4. ProcessPool 失败时自动回退到进程内串行分区执行

---

## 附录：原始数据路径索引

| 数据 | 路径 |
|------|------|
| Critical vs Random (本次) | `comparison_reports/critical_vs_random_20260219_113550.txt` |
| v1 vs v2 Planner (本次) | `_bench_compare.py` 运行输出 (2026-02-19 11:37) |
| v1 Panda Multi (本次) | `v1/benchmarks/output/panda_multi_20260219_113729/multi_scenario_report.txt` |
| v2 Panda Multi (本次) | `v2/output/benchmarks/panda_multi_20260219_113651/multi_scenario_report.txt` |
| FK Batch (本次) | `v2/output/benchmarks/aabb_fk_batch_20260219_113809/result.json` |
| FK Cython (本次) | `v2/output/benchmarks/aabb_fk_scalar_cython_20260219_113818/result.json` |
| 区间 FK (本次) | `v2/output/benchmarks/aabb_interval_fk_20260219_113824/result.txt` |
| 邻接向量化 (本次) | `v2/output/benchmarks/forest_adjacency_vectorized_20260219_113837/result.json` |
| KDTree (本次) | `v2/output/benchmarks/forest_kdtree_20260219_113845/result.txt` |
| 增量添加 (本次) | `v2/output/benchmarks/forest_incremental_add_20260219_113858/result.json` |
